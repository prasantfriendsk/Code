# Set variables
$orgId = "<your_org_id>"  # ‚Üê Replace this
$headers = @{
    "Authorization" = "token $env:SNYK_TOKEN"
    "Content-Type"  = "application/json"
}
$apiVersion = "2024-03-19~beta"
$baseUrl = "https://api.snyk.io/rest"
$limit = 100  # Snyk API max page size

# Output CSV path
$outputPath = ".\snyk_projects_report.csv"
$exportRows = @()

# Get paginated results with limit=100
function Get-PaginatedData {
    param (
        [string]$url
    )
    $results = @()
    do {
        $response = Invoke-RestMethod -Uri $url -Headers $headers -Method Get
        $results += $response.data
        $url = if ($response.links.next.href) {
            # Add API version back if missing in next URL
            if ($url -notlike "*version=*") {
                "$($response.links.next.href)?version=$apiVersion"
            } else {
                $response.links.next.href
            }
        } else {
            $null
        }
    } while ($url)
    return $results
}

# Get all projects
function Get-AllProjects {
    $url = "$baseUrl/orgs/$orgId/projects?version=$apiVersion&limit=$limit"
    return Get-PaginatedData -url $url
}

# Get project issues
function Get-ProjectIssues {
    param([string]$projectId)
    $url = "$baseUrl/orgs/$orgId/projects/$projectId/issues?version=$apiVersion&limit=$limit"
    return Get-PaginatedData -url $url
}

# Get project dependencies
function Get-ProjectDependencies {
    param([string]$projectId)
    $url = "$baseUrl/orgs/$orgId/projects/$projectId/dependencies?version=$apiVersion&limit=$limit"
    return Get-PaginatedData -url $url
}

# Run
$projects = Get-AllProjects
Write-Host "`nüì¶ Found $($projects.Count) projects.`n" -ForegroundColor Cyan

foreach ($project in $projects) {
    $projectId = $project.id
    $projectName = $project.attributes.name
    Write-Host "üîç Project: $projectName"

    # Get dependencies
    $deps = Get-ProjectDependencies -projectId $projectId
    $dependencyCount = $deps.Count

    # Get issues
    $issues = Get-ProjectIssues -projectId $projectId
    if ($issues.Count -eq 0) {
        # Export even if no issues
        $exportRows += [pscustomobject]@{
            ProjectName       = $projectName
            ProjectId         = $projectId
            IssueTitle        = ""
            IssueSeverity     = ""
            IssueType         = ""
            IssueIntroducedThrough = ""
            DependencyCount   = $dependencyCount
        }
    } else {
        foreach ($issue in $issues) {
            $exportRows += [pscustomobject]@{
                ProjectName       = $projectName
                ProjectId         = $projectId
                IssueTitle        = $issue.attributes.title
                IssueSeverity     = $issue.attributes.severity
                IssueType         = $issue.attributes.issueType
                IssueIntroducedThrough = ($issue.attributes.introducedThrough -join ", ")
                DependencyCount   = $dependencyCount
            }
        }
    }
}

# Export to CSV
$exportRows | Export-Csv -Path $outputPath -NoTypeInformation -Encoding UTF8
Write-Host "`n‚úÖ CSV Export complete: $outputPath`n" -ForegroundColor Green
