function Get-PaginatedData {
    param (
        [string]$url
    )

    $results = @()
    do {
        try {
            $response = Invoke-RestMethod -Uri $url -Headers $headers -Method Get
            $results += $response.data

            # Patch: Cleanly extract next URL and preserve version
            if ($response.PSObject.Properties['links'] -and $response.links.next.href) {
                # Remove any existing query strings
                $baseNextUrl = $response.links.next.href -replace '\?.*$', ''
                $url = "$baseNextUrl?version=$apiVersion&limit=$limit"
            } else {
                $url = $null
            }

        } catch {
            Write-Warning "‚ùå Error calling: $url"
            Write-Warning $_.Exception.Message
            $url = $null
        }
    } while ($url)

    return $results
}
